<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><title>Python Coroutines!?!? | aadalal</title><meta name="description" content="Generated by create next app"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="next-head-count" content="4"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous"/><link rel="icon" href="favicon.ico"/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/5c882c34218f54b4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5c882c34218f54b4.css" data-n-g=""/><link rel="preload" href="/_next/static/css/19b6bbb85053155c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/19b6bbb85053155c.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/darkmode-load.js" defer="" data-nscript="beforeInteractive"></script><script src="/_next/static/chunks/webpack-b8f8d6679aaa5f42.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-83cebdb887f48834.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2dfd096757008a0f.js" defer=""></script><script src="/_next/static/chunks/996-502a5e68cb1e9d91.js" defer=""></script><script src="/_next/static/chunks/236-56896faab121b877.js" defer=""></script><script src="/_next/static/chunks/pages/p/%5Bslug%5D-2d1ce316d81bb9cb.js" defer=""></script><script src="/_next/static/0-nV1MzsWdmIJ2GMWdViW/_buildManifest.js" defer=""></script><script src="/_next/static/0-nV1MzsWdmIJ2GMWdViW/_ssgManifest.js" defer=""></script></head><body><div id="__next"><main class="__className_a64ecd"><div class="full grid grid-cols-8 font-medium"><div class="col-span-8 md:col-span-2 p-4 border-2 flex flex-row justify-between items-center flex-shrink"><a class="font-bold text-xl" href="/">aadalal</a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" color="black" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" style="cursor:pointer;transform:rotate(90deg)"><mask id="circle-mask"><rect x="0" y="0" width="100%" height="100%" fill="white"></rect><circle style="cx:100%;cy:0%" r="9" fill="black"></circle></mask><circle cx="12" cy="12" fill="black" style="r:5px" mask="url(#circle-mask)"></circle><g stroke="currentColor" style="opacity:1"><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></g></svg></div><div class="col-span-0 hidden md:col-span-6 py-4 px-2 border-y-2 border-r-2 md:grid grid-cols-16 gap-6 overflow-hidden whitespace-nowrap items-center justify-center"><div class="col-span-5 flex justify-end items-center flex-shrink gap-5"><a class="opacity-75" href="/p/consistent-hashing">Consistent Hashing</a><a class="opacity-75" href="/p/rendevous-hashing">Rendevous Hashing</a></div><div class="col-span-6 flex flex-row justify-between items-center flex-shrink-0 z-10"><a id="previous-post" class="" href="/p/rendevous-hashing"><svg xmlns="http://www.w3.org/2000/svg" class="h-8" fill="currentColor" viewBox="144 64 224 384"><path d="M368 64L144 256l224 192V64z"></path></svg></a><div class="shrink text-2xl font-junicode bg-white dark:bg-black">Python Coroutines!?!?</div><a id="next-post" class="" href="/p/PMing"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="h-8 dark:text-white" viewBox="144 64 224 384"><path d="M144 448l224-192L144 64v384z"></path></svg></a></div><div class="col-span-5 flex justify-start items-center flex-shrink gap-5"><a class="opacity-75" href="/p/PMing">Lessons from Product Managing</a><a class="opacity-75" href="/p/einsum">Einsum</a><a class="opacity-75" href="/p/entropy">Entropy</a><a class="opacity-75" href="/p/_sudo">Try again with sudo: _sudo</a><a class="opacity-75" href="/p/competition-focus">Roku &amp; Competition</a></div></div></div><div class="mb-10"><article class="max-w-2xl mx-auto px-3 mt-4"><header><div class="italic opacity-75 mt-10 mb-5"><time>2023-06-11</time></div><h1 class="text-8xl w-3/4 font-junicode mb-10">Python Coroutines!?!?</h1></header><section class="prose dark:prose-invert prose-a:text-blue-600 dark:prose-a:text-blue-500 hover:prose-a:text-blue-900 hover:dark:prose-a:text-blue-800 dark:prose-pre:border-gray-900 dark:prose-pre:border"><p>Python supports generators which allow you to <code>.send()</code> and recieve (via <code>next(...)</code>) values. They are kind of like channels since they don't block until you send or recieve.</p>
<p>In the code below, we use callbacks (called aperiodically in a separate thread) to send values to our channel. Simultaneously, we try to consume those values, which should be allowed because generators and our <code>coroutine</code> are non-blocking.</p>
<pre><code class="language-python">import time, threading

def channel(x="Hello"):
    while True:
        x = yield x

def make_coroutine(callback):
    def coroutine():
        callback()
        threading.Timer(1, coroutine).start()
    return coroutine

def make_callback():
    chan = channel()
    # prime the channel
    next(chan)

    def callback():
        print("Calling!")
        chan.send("Hello world!")
    
    return chan, callback

def main():
    chan, callback = make_callback()
    coroutine = make_coroutine(callback)
    coroutine()
    for i in chan:
        if i is not None:
            print(i)

if __name__ == "__main__":
    main()
</code></pre>
<p>And yet, this approach doesn't work as expected! One of three things happens:</p>
<ol>
<li><code>ValueError: generator already executing</code></li>
<li>only None values are output from the channel</li>
</ol>
<p>Why doesn't this work? email me if you have an answer.</p></section></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Python Coroutines!?!?","date":"2023-06-11","slug":"py-generator-couroutines","content":"\u003cp\u003ePython supports generators which allow you to \u003ccode\u003e.send()\u003c/code\u003e and recieve (via \u003ccode\u003enext(...)\u003c/code\u003e) values. They are kind of like channels since they don't block until you send or recieve.\u003c/p\u003e\n\u003cp\u003eIn the code below, we use callbacks (called aperiodically in a separate thread) to send values to our channel. Simultaneously, we try to consume those values, which should be allowed because generators and our \u003ccode\u003ecoroutine\u003c/code\u003e are non-blocking.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-python\"\u003eimport time, threading\n\ndef channel(x=\"Hello\"):\n    while True:\n        x = yield x\n\ndef make_coroutine(callback):\n    def coroutine():\n        callback()\n        threading.Timer(1, coroutine).start()\n    return coroutine\n\ndef make_callback():\n    chan = channel()\n    # prime the channel\n    next(chan)\n\n    def callback():\n        print(\"Calling!\")\n        chan.send(\"Hello world!\")\n    \n    return chan, callback\n\ndef main():\n    chan, callback = make_callback()\n    coroutine = make_coroutine(callback)\n    coroutine()\n    for i in chan:\n        if i is not None:\n            print(i)\n\nif __name__ == \"__main__\":\n    main()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd yet, this approach doesn't work as expected! One of three things happens:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003eValueError: generator already executing\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eonly None values are output from the channel\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eWhy doesn't this work? email me if you have an answer.\u003c/p\u003e"},"morePosts":[{"title":"Consistent Hashing","slug":"consistent-hashing","date":"2023-10-26"},{"title":"Rendevous Hashing","slug":"rendevous-hashing","date":"2023-10-26"},{"title":"Python Coroutines!?!?","slug":"py-generator-couroutines","date":"2023-06-11"},{"title":"Lessons from Product Managing","slug":"PMing","date":"2023-06-01"},{"title":"Einsum","slug":"einsum","date":"2022-03-14"},{"title":"Entropy","slug":"entropy","date":"2021-12-28"},{"title":"Try again with sudo: _sudo","slug":"_sudo","date":"2021-11-11"},{"title":"Roku \u0026 Competition","slug":"competition-focus","date":"2021-11-11"}]},"__N_SSG":true},"page":"/p/[slug]","query":{"slug":"py-generator-couroutines"},"buildId":"0-nV1MzsWdmIJ2GMWdViW","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>